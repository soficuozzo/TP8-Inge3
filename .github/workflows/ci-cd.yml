name: CI-CD TP8

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:

  # ============ BUILD & TEST ============
  build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ------ BACKEND ------
    - name: Setup Node Backend
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Backend dependencies
      working-directory: backend
      run: npm ci

    - name: Run Backend Tests
      working-directory: backend
      run: npm test

    # ------ FRONTEND ------
    - name: Install Frontend dependencies
      working-directory: frontend
      run: npm ci

    - name: Run Frontend Tests
      working-directory: frontend
      run: npm test

    # Upload artifacts for docker build
    - name: Upload code
      uses: actions/upload-artifact@v4
      with:
        name: source
        path: .

  # ============ DOCKER BUILD & PUSH ============
  docker:
    needs: build-test
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        env: [ qa, prod ]

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: source
        path: .

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build Docker image
      run: |
        docker build \
          -f backend/Dockerfile \
          -t ghcr.io/${{ github.repository }}-backend:${{ matrix.env }} \
          ./backend

        docker build \
          -f frontend/Dockerfile \
          -t ghcr.io/${{ github.repository }}-frontend:${{ matrix.env }} \
          ./frontend

    - name: Push images
      run: |
        docker push ghcr.io/${{ github.repository }}-backend:${{ matrix.env }}
        docker push ghcr.io/${{ github.repository }}-frontend:${{ matrix.env }}

  # ============ DEPLOY QA ============
  deploy-qa:
    needs: docker
    runs-on: ubuntu-latest

    steps:
    - name: Trigger Render Deploy Backend QA
      run: |
        curl -X POST "${{ secrets.RENDER_BACKEND_QA_WEBHOOK }}"

    - name: Trigger Render Deploy Frontend QA
      run: |
        curl -X POST "${{ secrets.RENDER_FRONTEND_QA_WEBHOOK }}"
