name: CI/CD TP8 - Full Pipeline (QA + Cypress + PROD)

on:
  push:
    branches: [ main ]          # Todo automático
  # NO workflow_dispatch

env:
  REGISTRY: ghcr.io
  IMAGE_BACKEND: ghcr.io/soficuozzo/tp8-backend
  IMAGE_FRONTEND: ghcr.io/soficuozzo/tp8-frontend

# ============================================
# 1) BUILD-TEST → TESTS UNITARIOS + ARTIFACTS
# ============================================
jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # BACKEND TESTS
      - run: cd backend && npm ci
      - run: cd backend && npm test -- --coverage

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-code
          path: backend

      # FRONTEND TESTS
      - run: cd frontend && npm ci
      - run: cd frontend && npm test -- --coverage

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-code
          path: frontend


# ==================================================
# 2) BUILD-PUSH-QA → DESCARGA ARTIFACTS + DOCKER QA
# ==================================================
  build-push-qa:
    needs: build-test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # DESCARGAR ARTIFACTS
      - uses: actions/download-artifact@v4
        with:
          name: backend-code
          path: backend

      - uses: actions/download-artifact@v4
        with:
          name: frontend-code
          path: frontend

      # LOGIN GHCR
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # BUILD + PUSH BACKEND QA
      - run: docker build -t $IMAGE_BACKEND:qa backend
      - run: docker push $IMAGE_BACKEND:qa

      # BUILD + PUSH FRONTEND QA
      - run: docker build -t $IMAGE_FRONTEND:qa frontend
      - run: docker push $IMAGE_FRONTEND:qa


# ============================================
# 3) DEPLOY-QA + TESTS CYPRESS POST-QA
# ============================================
  deploy-qa:
    needs: build-push-qa
    runs-on: ubuntu-latest

    steps:
      - name: Deploy Backend QA
        run: curl -X POST "${{ secrets.RENDER_WEBHOOK_BACK_QA }}"

      - name: Deploy Frontend QA
        run: curl -X POST "${{ secrets.RENDER_WEBHOOK_FRONT_QA }}"

      # Esperar Render
      - run: sleep 45

      # CYPRESS TESTS POST-QA
      - uses: actions/checkout@v4

      - name: Install Cypress dependencies
        run: |
          cd frontend
          npm ci

      - name: Install Cypress
        run: |
          cd frontend
          npx cypress install

      - name: Run Cypress E2E
        run: |
          cd frontend
          npx cypress run --env FRONT_URL="https://tp8-frontend-qa-riob.onrender.com",API_URL="https://tp8-backend-qa-4u5j.onrender.com/api/tasks"


# ============================================================================
# 4) BUILD-PUSH-PROD → AUTOMÁTICO PERO REQUIERE APROBACIÓN DE ENVIRONMENT
# ============================================================================
  build-push-prod:
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment:
      name: production   # pide aprobación antes de seguir

    steps:
      - uses: actions/checkout@v4

      # Login GHCR
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # BUILD + PUSH BACKEND PROD
      - run: docker build -t $IMAGE_BACKEND:prod backend
      - run: docker push $IMAGE_BACKEND:prod

      # BUILD + PUSH FRONTEND PROD
      - run: docker build -t $IMAGE_FRONTEND:prod frontend
      - run: docker push $IMAGE_FRONTEND:prod


# ============================================
# 5) DEPLOY PROD AUTOMÁTICO + APROBACIÓN
# ============================================
  deploy-prod:
    needs: build-push-prod
    runs-on: ubuntu-latest
    environment:
      name: production   # este paso TAMBIÉN requiere aprobación

    steps:
      - run: curl -X POST "${{ secrets.RENDER_WEBHOOK_BACK_PROD }}"
      - run: curl -X POST "${{ secrets.RENDER_WEBHOOK_FRONT_PROD }}"
