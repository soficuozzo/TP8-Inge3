name: CI/CD TP8 - Full Pipeline (QA + Cypress + PROD)

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_BACKEND: ghcr.io/soficuozzo/TP8-Inge3/backend
  IMAGE_FRONTEND: ghcr.io/soficuozzo/TP8-Inge3/frontend


# ============================================
# 1) BUILD-TEST → TESTS UNITARIOS + ARTIFACTS
# ============================================
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Backend tests
      - run: cd backend && npm ci
      - run: cd backend && npm test -- --coverage

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-code
          path: backend

      # Frontend tests
      - run: cd frontend && npm ci
      - run: cd frontend && npm test -- --coverage

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-code
          path: frontend


# ==================================================
# 2) BUILD-PUSH-QA → DESCARGA ARTIFACTS + DOCKER QA
# ==================================================
  build-push-qa:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: backend-code
          path: backend

      - uses: actions/download-artifact@v4
        with:
          name: frontend-code
          path: frontend

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - run: docker build -t $IMAGE_BACKEND:qa backend
      - run: docker push $IMAGE_BACKEND:qa

      - run: docker build -t $IMAGE_FRONTEND:qa frontend
      - run: docker push $IMAGE_FRONTEND:qa


# ============================================
# 3) DEPLOY-QA + CYPRESS
# ============================================
  deploy-qa:
    needs: build-push-qa
    runs-on: ubuntu-latest
    environment:
      name: qa           # << aparece en Deployments como QA

    steps:
      - run: curl -X POST "${{ secrets.RENDER_WEBHOOK_BACK_QA }}"
      - run: curl -X POST "${{ secrets.RENDER_WEBHOOK_FRONT_QA }}"

      - run: sleep 45

      - uses: actions/checkout@v4

      - name: Install Cypress dependencies
        run: cd frontend && npm ci

      - name: Install Cypress
        run: cd frontend && npx cypress install

      - name: Run Cypress E2E against QA
        env:
          FRONT_URL: "https://tp8-frontend-qa-riob.onrender.com"
          API_URL: "https://tp8-backend-qa-4u5j.onrender.com/api/tasks"
        run: |
          cd frontend
          npx cypress run


# ============================================================================ 
# 4) BUILD-PUSH-PROD → AUTOMÁTICO + APROBACIÓN
# ============================================================================
  build-push-prod:
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment:
      name: production      # << esto aparece como "production" en Deployments
      url: https://tp8-frontend-prod.onrender.com

    steps:
      - uses: actions/checkout@v4

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - run: docker build -t $IMAGE_BACKEND:prod backend
      - run: docker push $IMAGE_BACKEND:prod

      - run: docker build -t $IMAGE_FRONTEND:prod frontend
      - run: docker push $IMAGE_FRONTEND:prod


# ============================================
# 5) DEPLOY PROD AUTOMÁTICO + APROBACIÓN
# ============================================
  deploy-prod:
    needs: build-push-prod
    runs-on: ubuntu-latest
    environment:
      name: production      # << MISMO ENV, REQUIERE APROBACIÓN

    steps:
      - run: curl -X POST "${{ secrets.RENDER_WEBHOOK_BACK_PROD }}"
      - run: curl -X POST "${{ secrets.RENDER_WEBHOOK_FRONT_PROD }}"
